<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="description" content="PrettyOrder Widget for MoySklad" />

    <!-- Google Fonts: JetBrains Mono -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              jet: [
                '"JetBrains Mono"',
                "ui-monospace",
                "SFMono-Regular",
                "Menlo",
                "monospace",
              ],
            },
          },
        },
      };
    </script>
  </head>
  <body class="h-full m-0 p-0 box-border font-jet text-[13px] leading-snug">
    <div class="space-y-3">
      <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->

      <div
        class="text-center bg-yellow-300/80 flex items-center gap-2 rounded-md p-4 py-1 mb-4"
      >
        <span class="animate-pulse text-2xl font-sans">‚ö°</span>
        <span class="text-xs text-slate-700 font-medium">
          –§–æ—Ä–º–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤—É—é –ø–æ–¥–±–æ—Ä–∫—É —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –∑–∞–∫–∞–∑—É –ø–æ–∫—É–ø–∞—Ç–µ–ª—è –∏ –¥–µ–ª–∏–º—Å—è
          —Å—Å—ã–ª–∫–æ–π —Å –∫–ª–∏–µ–Ω—Ç–æ–º.
        </span>
      </div>

      <!-- –í–µ—Ä—Ö–Ω–∏–π –±–ª–æ–∫: —Ç–µ–∫—É—â–∞—è —Å—Å—ã–ª–∫–∞ -->
      <section class="mt-4 flex flex-col items-center text-center gap-2">
        <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ: —Å—Å—ã–ª–∫–∏ –Ω–µ—Ç -->
        <div
          id="linkEmpty"
          class="flex items-center gap-1 text-xs text-slate-500"
        >
          <span>üîó</span>
          <span>–°—Å—ã–ª–∫–∞ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω–∞</span>
        </div>

        <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ: —Å—Å—ã–ª–∫–∞ –µ—Å—Ç—å -->
        <div
          id="linkArea"
          class="hidden w-full max-w-xl flex flex-wrap items-center justify-center gap-2"
        >
          <input
            id="linkUrl"
            type="text"
            readonly
            class="flex-1 min-w-0 px-2 py-1.5 rounded-md border border-slate-300 text-xs bg-white read-only:bg-slate-50 focus:outline-none focus:ring-1 focus:ring-slate-400"
          />
          <button
            id="copyBtn"
            type="button"
            disabled
            class="inline-flex items-center justify-center gap-1 px-3 py-1.5 rounded-md border text-xs font-medium bg-white text-slate-700 border-slate-300 disabled:opacity-50 disabled:cursor-default"
          >
            –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
          </button>
        </div>
      </section>

      <!-- –ù–∏–∂–Ω–∏–π –±–ª–æ–∫: –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
      <section
        class="mt-3 rounded-md border border-slate-200 bg-white px-4 py-3 shadow-sm"
      >
        <div class="space-y-1.5">
          <label class="flex items-center gap-1.5">
            <input
              id="hidePrices"
              type="checkbox"
              class="h-3 w-3 rounded border-slate-300 text-indigo-600"
            />
            <span class="text-[12px] text-slate-700">–°–∫—Ä—ã—Ç—å —Ü–µ–Ω—ã</span>
          </label>

          <label class="flex items-center gap-1.5">
            <input
              id="hideTotal"
              type="checkbox"
              class="h-3 w-3 rounded border-slate-300 text-indigo-600"
            />
            <span class="text-[12px] text-slate-700"
              >–°–∫—Ä—ã—Ç—å –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É</span
            >
          </label>
        </div>
      </section>

      <button
        id="createOrSaveBtn"
        type="button"
        disabled
        class="mt-3 inline-flex items-center justify-center w-full px-6 py-3 rounded-md text-[13px] font-medium bg-black text-white hover:bg-slate-800 disabled:opacity-50 disabled:cursor-default transition-colors"
      >
        –°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É
      </button>

      <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏ -->
      <div class="flex justify-center">
        <button
          id="deleteLinkBtn"
          type="button"
          disabled
          class="mt-2 mx-auto inline-flex items-center justify-center gap-1 text-[12px] text-red-500 hover:text-red-600 disabled:hidden disabled:cursor-default"
        >
          <span class="text-[14px]">üóë</span>
          <span>–£–¥–∞–ª–∏—Ç—å —Å—Å—ã–ª–∫—É</span>
        </button>
      </div>
    </div>

    <!-- –°—Ç–∞—Ç—É—Å ‚Äî –º–∞–ª–µ–Ω—å–∫–∏–π —Ç–µ–∫—Å—Ç –≤–Ω–∏–∑—É, –¥–ª—è —Å–µ–±—è -->
    <div id="statusText" class="mt-2 text-[11px] text-slate-400"></div>

    <script>
      (function () {
        // ‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò ‚Äî –ü–û–î–°–¢–ê–í–¨ –°–í–û–ô –ë–≠–ö–ï–ù–î
        var BACKEND_BASE_URL =
          "https://flawiest-overjoyous-chang.ngrok-free.dev/api";
        var PUBLIC_ORDER_ENDPOINT =
          BACKEND_BASE_URL + "/moysklad/public-order/";

        // --- helpers DOM ---
        function $(id) {
          return window.document.getElementById(id);
        }

        function setDisabled(id, disabled) {
          var el = $(id);
          if (el) el.disabled = disabled;
        }

        function setStatus(text, type) {
          var el = $("statusText");
          if (!el) return;
          var base = "mt-2 text-[11px] ";
          var color =
            type === "ok"
              ? "text-emerald-600"
              : type === "error"
              ? "text-red-600"
              : "text-slate-400";
          el.className = base + color;
          el.textContent = text || "";
        }

        // üîë contextKey –∏–∑ query (–Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ –±—ç–∫–µ–Ω–¥)
        var contextKey = null;
        (function readContextKey() {
          try {
            var params = new URLSearchParams(window.location.search);
            contextKey = params.get("contextKey");
          } catch (e) {
            console.error("Failed to read contextKey:", e);
          }
        })();

        // üßæ objectId –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è Open
        var objectId = null;
        var hostWindow = window.parent || window.top;

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã —Å –æ—Ç–≤–µ—Ç–æ–º –±—ç–∫–µ–Ω–¥–∞
        function syncFormFromResponse(data) {
          var exists = !!data && !!data.exists;

          var linkEmpty = $("linkEmpty");
          var linkArea = $("linkArea");
          var urlInput = $("linkUrl");
          var mainBtn = $("createOrSaveBtn");
          var deleteBtn = $("deleteLinkBtn");

          if (!urlInput || !linkEmpty || !linkArea || !mainBtn || !deleteBtn)
            return;

          if (exists && data.link_url) {
            // –ü–æ–∫–∞–∑–∞—Ç—å –±–ª–æ–∫ —Å–æ —Å—Å—ã–ª–∫–æ–π
            linkEmpty.classList.add("hidden");
            linkArea.classList.remove("hidden");

            urlInput.value = data.link_url;
            setDisabled("copyBtn", false);
            setDisabled("createOrSaveBtn", false);
            setDisabled("deleteLinkBtn", false);

            mainBtn.textContent = "–û–±–Ω–æ–≤–∏—Ç—å —Å—Å—ã–ª–∫—É";
          } else {
            // –°–∫—Ä—ã—Ç—å –±–ª–æ–∫ —Å–æ —Å—Å—ã–ª–∫–æ–π, –ø–æ–∫–∞–∑–∞—Ç—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
            linkEmpty.classList.remove("hidden");
            linkArea.classList.add("hidden");

            urlInput.value = "";
            urlInput.placeholder = "–°—Å—ã–ª–∫–∞ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω–∞";
            setDisabled("copyBtn", true);
            setDisabled("createOrSaveBtn", false);
            setDisabled("deleteLinkBtn", true);

            mainBtn.textContent = "–°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É";
          }

          if (data && typeof data.hide_prices === "boolean") {
            $("hidePrices").checked = data.hide_prices;
          }
          if (data && typeof data.hide_total === "boolean") {
            $("hideTotal").checked = data.hide_total;
          }
        }

        // üöÄ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Å—ã–ª–∫–∏
        function loadPublicOrder() {
          if (!contextKey || !objectId) {
            setStatus(
              "–ù–µ—Ç contextKey –∏–ª–∏ objectId ‚Äî –∂–¥—ë–º –¥–∞–Ω–Ω—ã–µ –æ—Ç –ú–æ–π–°–∫–ª–∞–¥–∞‚Ä¶",
              "info"
            );
            return;
          }

          setStatus("–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Å—ã–ª–∫–∏‚Ä¶", "info");
          setDisabled("createOrSaveBtn", true);

          var payload = {
            context_key: contextKey,
            ms_order_id: objectId,
          };

          fetch(PUBLIC_ORDER_ENDPOINT, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          })
            .then(function (res) {
              if (!res.ok) {
                throw new Error("HTTP " + res.status);
              }
              return res.json();
            })
            .then(function (data) {
              console.log("PublicOrder POST response:", data);
              setStatus("–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–æ", "ok");
              syncFormFromResponse(data || {});
            })
            .catch(function (err) {
              console.error("Failed to load public order:", err);
              setStatus(
                "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Å—ã–ª–∫–∏: " + err.message,
                "error"
              );
              syncFormFromResponse({ exists: false });
            })
            .finally(function () {
              setDisabled("createOrSaveBtn", false);
            });
        }

        // üíæ –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏
        function savePublicOrder() {
          if (!contextKey || !objectId) {
            setStatus(
              "–ù–µ—Ç contextKey –∏–ª–∏ objectId ‚Äî –ú–æ–π–°–∫–ª–∞–¥ –µ—â—ë –Ω–µ –ø–µ—Ä–µ–¥–∞–ª –∫–æ–Ω—Ç–µ–∫—Å—Ç",
              "error"
            );
            return;
          }

          var hidePrices = $("hidePrices").checked;
          var hideTotal = $("hideTotal").checked;

          setStatus("–°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É‚Ä¶", "info");
          setDisabled("createOrSaveBtn", true);

          var payload = {
            context_key: contextKey,
            ms_order_id: objectId,
            hide_prices: hidePrices,
            hide_total: hideTotal,
          };

          fetch(PUBLIC_ORDER_ENDPOINT, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          })
            .then(function (res) {
              if (!res.ok) {
                throw new Error("HTTP " + res.status);
              }
              return res.json();
            })
            .then(function (data) {
              console.log("PublicOrder PATCH response:", data);
              setStatus("–°—Å—ã–ª–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞", "ok");
              syncFormFromResponse(data || {});
            })
            .catch(function (err) {
              console.error("Failed to save public order:", err);
              setStatus("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏: " + err.message, "error");
            })
            .finally(function () {
              setDisabled("createOrSaveBtn", false);
            });
        }

        // üóë –£–¥–∞–ª–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏
        function deletePublicOrder() {
          if (!contextKey || !objectId) {
            setStatus(
              "–ù–µ—Ç contextKey –∏–ª–∏ objectId ‚Äî –ú–æ–π–°–∫–ª–∞–¥ –µ—â—ë –Ω–µ –ø–µ—Ä–µ–¥–∞–ª –∫–æ–Ω—Ç–µ–∫—Å—Ç",
              "error"
            );
            return;
          }

          setStatus("–£–¥–∞–ª—è–µ–º —Å—Å—ã–ª–∫—É‚Ä¶", "info");
          setDisabled("deleteLinkBtn", true);

          var payload = {
            context_key: contextKey,
            ms_order_id: objectId,
          };

          fetch(PUBLIC_ORDER_ENDPOINT, {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          })
            .then(function (res) {
              if (!res.ok && res.status !== 204) {
                throw new Error("HTTP " + res.status);
              }
              setStatus("–°—Å—ã–ª–∫–∞ —É–¥–∞–ª–µ–Ω–∞", "ok");
              // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–æ—Ä–º—ã
              syncFormFromResponse({ exists: false });
            })
            .catch(function (err) {
              console.error("Failed to delete public order:", err);
              setStatus("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏: " + err.message, "error");
              setDisabled("deleteLinkBtn", false);
            });
        }

        // üìã –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏
        function copyLinkToClipboard() {
          var urlInput = $("linkUrl");
          if (!urlInput || !urlInput.value) return;
          urlInput.select();
          urlInput.setSelectionRange(0, 99999);
          try {
            var ok = document.execCommand("copy");
            if (ok) {
              setStatus("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞", "ok");
            } else {
              setStatus("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É", "error");
            }
          } catch (e) {
            setStatus("–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: " + e.message, "error");
          } finally {
            window.getSelection().removeAllRanges();
          }
        }

        // üîî OpenFeedback (–ø–æ –∂–µ–ª–∞–Ω–∏—é, –±–µ–∑ –ª–æ–≥–æ–≤)
        function sendOpenFeedback(receivedMessage) {
          if (!receivedMessage || typeof receivedMessage !== "object") return;
          if (!receivedMessage.messageId) return;

          var sendingMessage = {
            name: "OpenFeedback",
            correlationId: receivedMessage.messageId,
          };
          if (hostWindow && hostWindow.postMessage) {
            hostWindow.postMessage(sendingMessage, "*");
          }
        }

        // üì® postMessage –æ—Ç –ú–æ–µ–≥–æ–°–∫–ª–∞–¥–∞
        window.addEventListener("message", function (event) {
          var receivedMessage = event.data;
          console.log("postMessage:", receivedMessage);

          if (!receivedMessage || typeof receivedMessage !== "object") return;

          if (receivedMessage.name === "Open") {
            objectId = receivedMessage.objectId || null;
            console.log("Got Open with objectId:", objectId);

            // –ó–∞–≥—Ä—É–∂–∞–µ–º/–ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Å—ã–ª–∫—É
            loadPublicOrder();

            // OpenFeedback (–∫–∞–∫ –≤ –¥–µ–º–æ)
            window.setTimeout(function () {
              sendOpenFeedback(receivedMessage);
            }, 200);
          }
        });

        // üîò –ü—Ä–∏–≤—è–∑–∫–∞ –∫–Ω–æ–ø–æ–∫
        window.addEventListener("DOMContentLoaded", function () {
          var createBtn = $("createOrSaveBtn");
          var copyBtn = $("copyBtn");
          var deleteBtn = $("deleteLinkBtn");

          if (createBtn) {
            createBtn.addEventListener("click", function () {
              savePublicOrder();
            });
          }
          if (copyBtn) {
            copyBtn.addEventListener("click", function () {
              copyLinkToClipboard();
            });
          }
          if (deleteBtn) {
            deleteBtn.addEventListener("click", function () {
              deletePublicOrder();
            });
          }

          setStatus("–ñ–¥—ë–º –¥–∞–Ω–Ω—ã–µ –æ—Ç –ú–æ–π–°–∫–ª–∞–¥–∞‚Ä¶", "info");
          setDisabled("createOrSaveBtn", false);
        });
      })();
    </script>
  </body>
</html>
