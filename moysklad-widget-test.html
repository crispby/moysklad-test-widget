<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="description" content="PrettyOrder Widget for MoySklad" />

    <!-- Google Fonts: JetBrains Mono -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              jet: [
                '"JetBrains Mono"',
                "ui-monospace",
                "SFMono-Regular",
                "Menlo",
                "monospace",
              ],
            },
          },
        },
      };
    </script>
  </head>

  <body class="min-h-screen m-0 p-0 box-border font-jet text-[13px] leading-snug">
    <div class="flex flex-col min-h-screen">

      <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
      <div class="space-y-3 flex-1">

        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div
          class="text-center bg-yellow-300/80 flex items-center gap-2 rounded-md p-4 py-1 mb-4"
        >
          <span class="animate-pulse text-2xl font-sans">‚ö°</span>
          <span class="text-xs text-slate-700 font-medium">
            –§–æ—Ä–º–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤—É—é –ø–æ–¥–±–æ—Ä–∫—É —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –∑–∞–∫–∞–∑—É –ø–æ–∫—É–ø–∞—Ç–µ–ª—è –∏ –¥–µ–ª–∏–º—Å—è —Å—Å—ã–ª–∫–æ–π.
          </span>
        </div>

        <!-- –í–µ—Ä—Ö–Ω–∏–π –±–ª–æ–∫: —Ç–µ–∫—É—â–∞—è —Å—Å—ã–ª–∫–∞ -->
        <section class="mt-4 flex flex-col items-center text-center gap-2">

          <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ: —Å—Å—ã–ª–∫–∏ –Ω–µ—Ç -->
          <div id="linkEmpty" class="flex items-center gap-1 text-xs text-slate-500">
            <span>üîó</span>
            <span>–°—Å—ã–ª–∫–∞ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω–∞</span>
          </div>

          <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ: —Å—Å—ã–ª–∫–∞ –µ—Å—Ç—å -->
          <div
            id="linkArea"
            class="hidden w-full max-w-xl flex flex-wrap items-center justify-center gap-2"
          >
            <input
              id="linkUrl"
              type="text"
              readonly
              class="flex-1 min-w-0 px-2 py-1.5 rounded-md border border-slate-300 text-xs bg-white focus:outline-none focus:ring-1 focus:ring-slate-400"
            />

            <button
              id="copyBtn"
              type="button"
              disabled
              class="inline-flex items-center justify-center gap-1 px-3 py-1.5 rounded-md border text-xs font-medium bg-white text-slate-700 border-slate-300 disabled:opacity-50"
            >
              –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
            </button>
          </div>
        </section>

        <!-- –ù–∏–∂–Ω–∏–π –±–ª–æ–∫: –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <section class="mt-3 rounded-md border border-slate-200 bg-white px-4 py-3 shadow-sm">
          <div class="space-y-1.5">

            <label class="flex items-center gap-1.5">
              <input id="hidePrices"
                     type="checkbox"
                     class="h-3 w-3 rounded border-slate-300 text-indigo-600" />
              <span class="text-[12px] text-slate-700">–°–∫—Ä—ã—Ç—å —Ü–µ–Ω—ã</span>
            </label>

            <label class="flex items-center gap-1.5">
              <input id="hideTotal"
                     type="checkbox"
                     class="h-3 w-3 rounded border-slate-300 text-indigo-600" />
              <span class="text-[12px] text-slate-700">–°–∫—Ä—ã—Ç—å –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É</span>
            </label>

          </div>
        </section>

        <!-- –°–æ–∑–¥–∞—Ç—å / –°–æ—Ö—Ä–∞–Ω–∏—Ç—å -->
        <button
          id="createOrSaveBtn"
          type="button"
          disabled
          class="mt-3 inline-flex items-center justify-center w-full px-6 py-3 rounded-md text-[13px] font-medium bg-black text-white hover:bg-slate-800 disabled:opacity-50"
        >
          –°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É
        </button>

        <!-- –£–¥–∞–ª–∏—Ç—å —Å—Å—ã–ª–∫—É -->
        <div class="flex justify-center">
          <button
            id="deleteLinkBtn"
            type="button"
            disabled
            class="mt-2 inline-flex items-center justify-center gap-1 text-[12px] text-red-500 hover:text-red-600 disabled:hidden"
          >
            <span class="text-[14px]">üóë</span>
            <span>–£–¥–∞–ª–∏—Ç—å —Å—Å—ã–ª–∫—É</span>
          </button>
        </div>

      </div>

      <!-- –°—Ç–∞—Ç—É—Å ‚Äî –≤—Å–µ–≥–¥–∞ –≤–Ω–∏–∑—É -->
      <div id="statusText" class="mt-2 mb-2 text-[11px] text-center text-slate-400"></div>
    </div>

<script>
(function () {

  // backend URL
  var BACKEND_BASE_URL = "https://flawiest-overjoyous-chang.ngrok-free.dev/api";
  var PUBLIC_ORDER_ENDPOINT = BACKEND_BASE_URL + "/moysklad/public-order/";

  function $(id) { return document.getElementById(id); }

  function setDisabled(id, flag) {
    var el = $(id);
    if (el) el.disabled = flag;
  }

  function setStatus(text, type) {
    var el = $("statusText");
    if (!el) return;
    var color =
      type === "ok" ? "text-emerald-600" :
      type === "error" ? "text-red-600" :
      "text-slate-400";
    el.className = "mt-2 mb-2 text-[11px] text-center " + color;
    el.textContent = text || "";
  }

  // contextKey –∏–∑ URL
  var contextKey = null;
  try {
    contextKey = new URLSearchParams(location.search).get("contextKey");
  } catch (_) {}

  var objectId = null;
  var isLoadingPublicOrder = false;

  // –°–±—Ä–æ—Å –≤–∏–¥–∂–µ—Ç–∞
  function resetWidgetState() {
    $("linkEmpty").classList.remove("hidden");
    $("linkArea").classList.add("hidden");

    $("linkUrl").value = "";
    setDisabled("copyBtn", true);
    setDisabled("deleteLinkBtn", true);

    $("createOrSaveBtn").textContent = "–°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É";

    $("hidePrices").checked = false;
    $("hideTotal").checked = false;
  }

  // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
  function syncFormFromResponse(data) {
    var exists = data && data.exists;

    var linkEmpty = $("linkEmpty");
    var linkArea  = $("linkArea");
    var urlInput  = $("linkUrl");
    var copyBtn   = $("copyBtn");
    var deleteBtn = $("deleteLinkBtn");
    var mainBtn   = $("createOrSaveBtn");

    if (!linkEmpty || !linkArea || !urlInput || !copyBtn || !deleteBtn || !mainBtn)
      return;

    if (exists && data.link_url) {
      linkEmpty.classList.add("hidden");
      linkArea.classList.remove("hidden");

      urlInput.value = data.link_url;
      setDisabled("copyBtn", false);
      setDisabled("deleteLinkBtn", false);

      mainBtn.textContent = "–û–±–Ω–æ–≤–∏—Ç—å —Å—Å—ã–ª–∫—É";
    } else {
      resetWidgetState();
    }

    if (typeof data.hide_prices === "boolean") {
      $("hidePrices").checked = data.hide_prices;
    }
    if (typeof data.hide_total === "boolean") {
      $("hideTotal").checked = data.hide_total;
    }
  }


  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Å—ã–ª–∫–∏
  function loadPublicOrder() {
    if (!contextKey || !objectId) {
      setStatus("–ñ–¥—ë–º –¥–∞–Ω–Ω—ã–µ –æ—Ç –ú–æ–π–°–∫–ª–∞–¥–∞‚Ä¶", "info");
      return;
    }

    if (isLoadingPublicOrder) {
      console.log("loadPublicOrder: skip, already loading");
      return;
    }

    isLoadingPublicOrder = true;
    setStatus("–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Å—ã–ª–∫–∏‚Ä¶", "info");
    setDisabled("createOrSaveBtn", true);

    var payload = {
      context_key: contextKey,
      ms_order_id: objectId,
    };

    fetch(PUBLIC_ORDER_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    })
      .then(function (res) {
        if (!res.ok) {
          return res.json().then(function (msg) {
            console.error("API error:", msg);
            throw new Error("HTTP " + res.status);
          });
        }
        return res.json();
      })
      .then(function (data) {
        console.log("POST response:", data);
        setStatus("–ì–æ—Ç–æ–≤–æ", "ok");
        syncFormFromResponse(data);
      })
      .catch(function (err) {
        console.error("load error:", err);
        setStatus("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏", "error");
        resetWidgetState();
      })
      .finally(function () {
        isLoadingPublicOrder = false;
        setDisabled("createOrSaveBtn", false);
      });
  }


  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (—Å–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
  function savePublicOrder() {
    if (!contextKey || !objectId) {
      setStatus("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞", "error");
      return;
    }

    var payload = {
      context_key: contextKey,
      ms_order_id: objectId,
      hide_prices: $("hidePrices").checked,
      hide_total: $("hideTotal").checked,
    };

    setStatus("–°–æ—Ö—Ä–∞–Ω—è–µ–º‚Ä¶", "info");
    setDisabled("createOrSaveBtn", true);

    fetch(PUBLIC_ORDER_ENDPOINT, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    })
      .then((res) => res.json())
      .then((data) => {
        console.log("PATCH response:", data);
        setStatus("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ", "ok");
        syncFormFromResponse(data);
      })
      .catch((err) => {
        console.error(err);
        setStatus("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è", "error");
      })
      .finally(() => {
        setDisabled("createOrSaveBtn", false);
      });
  }

  // –£–¥–∞–ª–µ–Ω–∏–µ
  function deletePublicOrder() {
    if (!contextKey || !objectId) {
      setStatus("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞", "error");
      return;
    }

    setStatus("–£–¥–∞–ª—è–µ–º‚Ä¶", "info");
    setDisabled("deleteLinkBtn", true);

    fetch(PUBLIC_ORDER_ENDPOINT, {
      method: "DELETE",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        context_key: contextKey,
        ms_order_id: objectId,
      }),
    })
      .then((res) => {
        if (!res.ok && res.status !== 204) {
          throw new Error("HTTP " + res.status);
        }
        setStatus("–°—Å—ã–ª–∫–∞ —É–¥–∞–ª–µ–Ω–∞", "ok");
        resetWidgetState();
      })
      .catch((err) => {
        console.error(err);
        setStatus("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è", "error");
        setDisabled("deleteLinkBtn", false);
      });
  }

  // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏
  function copyLinkToClipboard() {
    var input = $("linkUrl");
    if (!input || !input.value) return;

    input.select();
    document.execCommand("copy");
    window.getSelection().removeAllRanges();

    setStatus("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ", "ok");
  }


  // –û–±—Ä–∞–±–æ—Ç–∫–∞ postMessage(Open)
  window.addEventListener("message", function (event) {
    var msg = event.data;
    if (!msg || typeof msg !== "object") return;

    if (msg.name === "Open") {
      objectId = msg.objectId || null;
      console.log("Open event, objectId=", objectId);
      resetWidgetState();            // –≤–∞–∂–Ω–æ!
      loadPublicOrder();             // –≥—Ä—É–∑–∏–º –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    }
  });


  // –ü—Ä–∏–≤—è–∑–∫–∞ –∫–Ω–æ–ø–æ–∫
  window.addEventListener("DOMContentLoaded", function () {
    $("createOrSaveBtn").onclick = savePublicOrder;
    $("copyBtn").onclick = copyLinkToClipboard;
    $("deleteLinkBtn").onclick = deletePublicOrder;

    setStatus("–ñ–¥—ë–º –¥–∞–Ω–Ω—ã–µ –æ—Ç –ú–æ–π–°–∫–ª–∞–¥–∞‚Ä¶", "info");
  });

})();
</script>

</body>
</html>