<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">

  <title>PrettyOrder ‚Äî –≤–∏–¥–∂–µ—Ç –∑–∞–∫–∞–∑–∞</title>
  <meta name="description" content="PrettyOrder Widget for MoySklad">

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 13px;
      line-height: 1.4;
    }

    .root {
      padding: 12px;
    }

    .title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .subtitle {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 12px;
    }

    .section {
      margin-top: 12px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
    }

    .section h2 {
      margin: 0 0 6px 0;
      font-size: 13px;
      font-weight: 600;
      color: #111827;
    }

    .field-label {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 2px;
    }

    .field-value {
      font-size: 13px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      word-break: break-all;
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    .input {
      flex: 1 1 auto;
      min-width: 0;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 12px;
      font-family: inherit;
      background: #ffffff;
    }

    .input[readonly] {
      background: #f3f4f6;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn-primary {
      background: #2563eb;
      border-color: #2563eb;
      color: #ffffff;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .switch-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
    }

    .switch-row label {
      font-size: 12px;
      color: #374151;
      cursor: pointer;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 500;
    }

    .badge-green {
      background: #dcfce7;
      color: #166534;
    }

    .badge-gray {
      background: #e5e7eb;
      color: #374151;
    }

    .status {
      font-size: 12px;
      margin-top: 4px;
    }

    .status-ok {
      color: #15803d;
    }

    .status-error {
      color: #b91c1c;
    }

    .status-info {
      color: #4b5563;
    }

    .messages {
      font-size: 11px;
      background: #111827;
      color: #e5e7eb;
      border-radius: 6px;
      padding: 6px;
      max-height: 160px;
      overflow: auto;
      margin-top: 4px;
    }

    .messages-item {
      margin-bottom: 2px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .hint {
      cursor: default;
      color: #9ca3af;
    }
  </style>
</head>
<body>
<div class="root">
  <div class="title">PrettyOrder ‚Äî –≤–∏–¥–∂–µ—Ç –∑–∞–∫–∞–∑–∞</div>
  <div class="subtitle">
    –§–æ—Ä–º–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤—É—é –ø–æ–¥–±–æ—Ä–∫—É —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –∑–∞–∫–∞–∑—É –ø–æ–∫—É–ø–∞—Ç–µ–ª—è –∏ –¥–µ–ª–∏–º—Å—è —Å—Å—ã–ª–∫–æ–π —Å –∫–ª–∏–µ–Ω—Ç–æ–º.
  </div>

  <!-- –ë–ª–æ–∫: –∫–æ–Ω—Ç–µ–∫—Å—Ç -->
  <div class="section">
    <h2>–ö–æ–Ω—Ç–µ–∫—Å—Ç</h2>

    <div class="field-label">contextKey –∏–∑ URL (–¥–ª—è –±—ç–∫–µ–Ω–¥–∞):</div>
    <div id="contextKey" class="field-value">‚Äî</div>

    <div class="field-label" style="margin-top:6px;">ID –∑–∞–∫–∞–∑–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è (objectId –∏–∑ Open):</div>
    <div id="objectId" class="field-value">–û–∂–∏–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ Open‚Ä¶</div>
  </div>

  <!-- –ë–ª–æ–∫: —Å—Å—ã–ª–∫–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ -->
  <div class="section">
    <h2>
      –ü—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
      <span id="linkBadge" class="badge badge-gray" style="margin-left:6px;">–°—Å—ã–ª–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞</span>
    </h2>

    <div class="row">
      <input id="linkUrl" class="input" type="text" readonly placeholder="–°—Å—ã–ª–∫–∞ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω–∞">
      <button id="copyBtn" class="btn" type="button" disabled>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      <button id="refreshBtn" class="btn" type="button" disabled>–û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>

    <div class="switch-row">
      <input type="checkbox" id="hidePrices">
      <label for="hidePrices">–°–∫—Ä—ã—Ç—å —Ü–µ–Ω—ã</label>
    </div>
    <div class="switch-row">
      <input type="checkbox" id="hideTotal">
      <label for="hideTotal">–°–∫—Ä—ã—Ç—å –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É</label>
    </div>

    <div class="row" style="margin-top:8px;">
      <button id="createOrSaveBtn" class="btn btn-primary" type="button" disabled>
        –°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É
      </button>
    </div>

    <div id="statusText" class="status status-info"></div>
  </div>

  <!-- –ë–ª–æ–∫: —Å–æ–æ–±—â–µ–Ω–∏—è -->
  <div class="section">
    <h2>
      –°–æ–æ–±—â–µ–Ω–∏—è <span class="hint" title="–õ–æ–≥ –≤—Ö–æ–¥—è—â–∏—Ö –æ—Ç —Ö–æ—Å—Ç-–æ–∫–Ω–∞ –∏ –∏—Å—Ö–æ–¥—è—â–∏—Ö –æ—Ç –≤–∏–¥–∂–µ—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (postMessage)">(?)</span>
    </h2>
    <div id="messages" class="messages"></div>
  </div>
</div>

<script>
  (function () {
    // ‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò ‚Äî –ó–ê–ú–ï–ù–ò –≠–¢–û –ù–ê –°–í–û–ô –ë–≠–ö–ï–ù–î
    // –ë–∞–∑–æ–≤—ã–π URL —Ç–≤–æ–µ–≥–æ API (–±–µ–∑ –∑–∞–≤–µ—Ä—à–∞—é—â–µ–≥–æ —Å–ª—ç—à–∞)
    var BACKEND_BASE_URL = 'https://YOUR_BACKEND_HOST/api';

    // –≠–Ω–¥–ø–æ–∏–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏/–∏–ª–∏ —Å–æ–∑–¥–∞—ë—Ç —Å—Å—ã–ª–∫—É.
    // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç:
    //  POST { contextKey, objectId, hide_prices?, hide_total? }
    //  ‚Ü™ { exists: bool, link_url?: string, hide_prices?: bool, hide_total?: bool }
    var PUBLIC_ORDER_ENDPOINT = BACKEND_BASE_URL + '/moysklad/public-order/';

    // üîß –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ DOM
    function $(id) {
      return window.document.getElementById(id);
    }

    function setText(id, text) {
      var el = $(id);
      if (el) el.textContent = text;
    }

    function setValue(id, value) {
      var el = $(id);
      if (el) el.value = value;
    }

    function setDisabled(id, disabled) {
      var el = $(id);
      if (el) el.disabled = disabled;
    }

    function setBadge(exists) {
      var el = $('linkBadge');
      if (!el) return;
      if (exists) {
        el.className = 'badge badge-green';
        el.textContent = '–°—Å—ã–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞';
      } else {
        el.className = 'badge badge-gray';
        el.textContent = '–°—Å—ã–ª–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞';
      }
    }

    function setStatus(text, type) {
      var el = $('statusText');
      if (!el) return;
      el.textContent = text || '';
      el.className = 'status ' + (type || 'status-info');
    }

    function addMessage(prefix, msg) {
      var messages = $('messages');
      if (!messages) return;
      var line = document.createElement('div');
      line.className = 'messages-item';
      var asString;
      try {
        asString = JSON.stringify(msg);
      } catch (e) {
        asString = String(msg);
      }
      line.textContent = prefix + ' ' + asString;
      messages.insertBefore(line, messages.firstChild);
    }

    function logReceivedMessage(msg) {
      addMessage('‚Üí Received', msg);
      console.log('‚Üí Received message:', msg);
    }

    function logSendingMessage(msg) {
      addMessage('‚Üê Sending', msg);
      console.log('‚Üê Sending message:', msg);
    }

    // üîë contextKey –∏–∑ query
    var contextKey = null;
    (function readContextKey() {
      try {
        var params = new URLSearchParams(window.location.search);
        contextKey = params.get('contextKey');
        setText('contextKey', contextKey || '‚Äî –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ query-–ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö');
      } catch (e) {
        console.error('Failed to read contextKey:', e);
      }
    })();

    // üßæ objectId –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è Open
    var objectId = null;
    var hostWindow = window.parent || window.top;

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–æ—Ä–º—ã
    function syncFormFromResponse(data) {
      var exists = !!data && !!data.exists;
      setBadge(exists);

      var urlInput = $('linkUrl');
      if (!urlInput) return;

      if (exists && data.link_url) {
        urlInput.value = data.link_url;
        setDisabled('copyBtn', false);
        setDisabled('refreshBtn', false);
        setDisabled('createOrSaveBtn', false);
        $('createOrSaveBtn').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏';
      } else {
        urlInput.value = '';
        urlInput.placeholder = '–°—Å—ã–ª–∫–∞ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω–∞';
        setDisabled('copyBtn', true);
        setDisabled('refreshBtn', false);
        setDisabled('createOrSaveBtn', false);
        $('createOrSaveBtn').textContent = '–°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É';
      }

      if (data && typeof data.hide_prices === 'boolean') {
        $('hidePrices').checked = data.hide_prices;
      }
      if (data && typeof data.hide_total === 'boolean') {
        $('hideTotal').checked = data.hide_total;
      }
    }

    // üöÄ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Å—ã–ª–∫–∏ —Å –±—ç–∫–µ–Ω–¥–∞
    function loadPublicOrder() {
      if (!contextKey || !objectId) {
        setStatus('–ù–µ—Ç contextKey –∏–ª–∏ objectId ‚Äî –∂–¥—ë–º –¥–∞–Ω–Ω—ã–µ –æ—Ç –ú–æ–π–°–∫–ª–∞–¥–∞‚Ä¶', 'status-info');
        return;
      }

      setStatus('–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Å—ã–ª–∫–∏‚Ä¶', 'status-info');
      setDisabled('createOrSaveBtn', true);
      setDisabled('refreshBtn', true);

      var payload = {
        contextKey: contextKey,
        objectId: objectId
      };

      fetch(PUBLIC_ORDER_ENDPOINT, {
        method: 'POST', // –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º –∞–ø—Å–µ—Ä—Ç–æ–º/–ø–æ–ª—É—á–µ–Ω–∏–µ
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      })
        .then(function (res) {
          if (!res.ok) {
            throw new Error('HTTP ' + res.status);
          }
          return res.json();
        })
        .then(function (data) {
          setStatus('–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'status-ok');
          syncFormFromResponse(data || {});
        })
        .catch(function (err) {
          console.error('Failed to load public order:', err);
          setStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Å—ã–ª–∫–∏: ' + err.message, 'status-error');
          syncFormFromResponse({ exists: false });
        })
        .finally(function () {
          setDisabled('createOrSaveBtn', false);
          setDisabled('refreshBtn', false);
        });
    }

    // üíæ –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏
    function savePublicOrder() {
      if (!contextKey || !objectId) {
        setStatus('–ù–µ—Ç contextKey –∏–ª–∏ objectId ‚Äî –ú–æ–π–°–∫–ª–∞–¥ –µ—â—ë –Ω–µ –ø–µ—Ä–µ–¥–∞–ª –∫–æ–Ω—Ç–µ–∫—Å—Ç', 'status-error');
        return;
      }

      var hidePrices = $('hidePrices').checked;
      var hideTotal = $('hideTotal').checked;

      setStatus('–°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É‚Ä¶', 'status-info');
      setDisabled('createOrSaveBtn', true);

      var payload = {
        contextKey: contextKey,
        objectId: objectId,
        hide_prices: hidePrices,
        hide_total: hideTotal
      };

      fetch(PUBLIC_ORDER_ENDPOINT, {
        method: 'PATCH', // –∏–ª–∏ POST, –µ—Å–ª–∏ —É–¥–æ–±–Ω–µ–µ ‚Äî –Ω–∞ –±—ç–∫–µ–Ω–¥–µ –º–æ–∂–µ—à—å –ø—Ä–∏–Ω–∏–º–∞—Ç—å –æ–±–∞
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      })
        .then(function (res) {
          if (!res.ok) {
            throw new Error('HTTP ' + res.status);
          }
          return res.json();
        })
        .then(function (data) {
          setStatus('–°—Å—ã–ª–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', 'status-ok');
          syncFormFromResponse(data || {});
        })
        .catch(function (err) {
          console.error('Failed to save public order:', err);
          setStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏: ' + err.message, 'status-error');
        })
        .finally(function () {
          setDisabled('createOrSaveBtn', false);
        });
    }

    // üìã –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏
    function copyLinkToClipboard() {
      var urlInput = $('linkUrl');
      if (!urlInput || !urlInput.value) return;
      urlInput.select();
      urlInput.setSelectionRange(0, 99999);
      try {
        var ok = document.execCommand('copy');
        if (ok) {
          setStatus('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'status-ok');
        } else {
          setStatus('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É', 'status-error');
        }
      } catch (e) {
        setStatus('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ' + e.message, 'status-error');
      } finally {
        window.getSelection().removeAllRanges();
      }
    }

    // üîî OpenFeedback (–∫–∞–∫ –≤ –¥–µ–º–æ ‚Äî –ø–æ –∂–µ–ª–∞–Ω–∏—é)
    function sendOpenFeedback(receivedMessage) {
      if (!receivedMessage || typeof receivedMessage !== 'object') return;
      if (!receivedMessage.messageId) return;

      var sendingMessage = {
        name: 'OpenFeedback',
        correlationId: receivedMessage.messageId
      };
      logSendingMessage(sendingMessage);
      if (hostWindow && hostWindow.postMessage) {
        hostWindow.postMessage(sendingMessage, '*');
      }
    }

    // üì® –û–±—Ä–∞–±–æ—Ç—á–∏–∫ postMessage –æ—Ç –ú–æ–µ–≥–æ–°–∫–ª–∞–¥–∞
    window.addEventListener('message', function (event) {
      var receivedMessage = event.data;
      logReceivedMessage(receivedMessage);

      if (!receivedMessage || typeof receivedMessage !== 'object') return;

      if (receivedMessage.name === 'Open') {
        objectId = receivedMessage.objectId || null;
        setText('objectId', objectId || 'objectId = null (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞)');

        // –ó–∞–≥—Ä—É–∂–∞–µ–º/—Å–æ–∑–¥–∞—ë–º —Å—Å—ã–ª–∫—É –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ contextKey + objectId
        loadPublicOrder();

        // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º OpenFeedback (–∫–∞–∫ –≤ –¥–µ–º–æ)
        window.setTimeout(function () {
          sendOpenFeedback(receivedMessage);
        }, 200);
      }
    });

    // üîò –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
    window.addEventListener('DOMContentLoaded', function () {
      var createBtn = $('createOrSaveBtn');
      var copyBtn = $('copyBtn');
      var refreshBtn = $('refreshBtn');

      if (createBtn) {
        createBtn.addEventListener('click', function () {
          savePublicOrder();
        });
      }
      if (copyBtn) {
        copyBtn.addEventListener('click', function () {
          copyLinkToClipboard();
        });
      }
      if (refreshBtn) {
        refreshBtn.addEventListener('click', function () {
          loadPublicOrder();
        });
      }

      // –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞—Ö–æ–¥–µ —É –Ω–∞—Å –µ—â—ë –Ω–µ—Ç objectId ‚Äî –∂–¥—ë–º Open
      setStatus('–ñ–¥—ë–º –¥–∞–Ω–Ω—ã–µ –æ—Ç –ú–æ–π–°–∫–ª–∞–¥–∞‚Ä¶', 'status-info');
      setDisabled('createOrSaveBtn', false);
      setDisabled('refreshBtn', false);
    });
  })();
</script>
</body>
</html>
