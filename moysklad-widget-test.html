<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <title>PrettyOrder ‚Äî –≤–∏–¥–∂–µ—Ç –∑–∞–∫–∞–∑–∞</title>
    <meta
      name="description"
      content="PrettyOrder Widget for MoySklad"
    />

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {},
        },
      };
    </script>
  </head>
  <body class="h-full m-0 p-0 box-border font-sans text-[13px] leading-snug bg-white">
    <div class="p-3 space-y-3">
      <div>
        <div class="text-[16px] font-semibold mb-1">
          PrettyOrder ‚Äî –≤–∏–¥–∂–µ—Ç –∑–∞–∫–∞–∑–∞
        </div>
        <div class="text-xs text-slate-500">
          –§–æ—Ä–º–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤—É—é –ø–æ–¥–±–æ—Ä–∫—É —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –∑–∞–∫–∞–∑—É –ø–æ–∫—É–ø–∞—Ç–µ–ª—è –∏ –¥–µ–ª–∏–º—Å—è —Å—Å—ã–ª–∫–æ–π —Å –∫–ª–∏–µ–Ω—Ç–æ–º.
        </div>
      </div>

      <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç -->
      <section class="mt-1 rounded-lg border border-slate-200 bg-slate-50 px-3 py-2.5 space-y-1.5">
        <h2 class="text-[13px] font-semibold text-slate-900">
          –ö–æ–Ω—Ç–µ–∫—Å—Ç
        </h2>

        <div>
          <div class="text-[11px] text-slate-500 mb-0.5">
            contextKey –∏–∑ URL (–¥–ª—è –±—ç–∫–µ–Ω–¥–∞):
          </div>
          <div id="contextKey" class="text-[13px] font-mono break-all text-slate-800">
            ‚Äî
          </div>
        </div>

        <div class="mt-1.5">
          <div class="text-[11px] text-slate-500 mb-0.5">
            ID –∑–∞–∫–∞–∑–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è (objectId –∏–∑ Open):
          </div>
          <div id="objectId" class="text-[13px] font-mono break-all text-slate-800">
            –û–∂–∏–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ Open‚Ä¶
          </div>
        </div>
      </section>

      <!-- –°—Å—ã–ª–∫–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ -->
      <section class="rounded-lg border border-slate-200 bg-slate-50 px-3 py-2.5 space-y-2">
        <div class="flex items-center justify-between gap-2">
          <h2 class="text-[13px] font-semibold text-slate-900">
            –ü—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
          </h2>
          <span
            id="linkBadge"
            class="inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-medium bg-slate-200 text-slate-700"
          >
            –°—Å—ã–ª–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞
          </span>
        </div>

        <div class="flex flex-wrap items-center gap-2 mt-1.5">
          <input
            id="linkUrl"
            type="text"
            readonly
            placeholder="–°—Å—ã–ª–∫–∞ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω–∞"
            class="flex-1 min-w-0 px-2 py-1.5 rounded-md border border-slate-300 text-xs bg-white read-only:bg-slate-100 focus:outline-none focus:ring-1 focus:ring-slate-400"
          />
          <button
            id="copyBtn"
            type="button"
            disabled
            class="inline-flex items-center justify-center gap-1 px-3 py-1.5 rounded-full border text-xs font-medium bg-white text-slate-700 border-slate-300 disabled:opacity-50 disabled:cursor-default"
          >
            –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
          </button>
          <button
            id="refreshBtn"
            type="button"
            disabled
            class="inline-flex items-center justify-center gap-1 px-3 py-1.5 rounded-full border text-xs font-medium bg-white text-slate-700 border-slate-300 disabled:opacity-50 disabled:cursor-default"
          >
            –û–±–Ω–æ–≤–∏—Ç—å
          </button>
        </div>

        <div class="flex items-center gap-1.5 mt-1.5">
          <input id="hidePrices" type="checkbox" class="h-3 w-3 rounded border-slate-300 text-blue-600" />
          <label for="hidePrices" class="text-[12px] text-slate-700 cursor-pointer">
            –°–∫—Ä—ã—Ç—å —Ü–µ–Ω—ã
          </label>
        </div>
        <div class="flex items-center gap-1.5 mt-0.5">
          <input id="hideTotal" type="checkbox" class="h-3 w-3 rounded border-slate-300 text-blue-600" />
          <label for="hideTotal" class="text-[12px] text-slate-700 cursor-pointer">
            –°–∫—Ä—ã—Ç—å –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É
          </label>
        </div>

        <div class="flex flex-wrap items-center gap-2 mt-2">
          <button
            id="createOrSaveBtn"
            type="button"
            disabled
            class="inline-flex items-center justify-center gap-1 px-3 py-1.5 rounded-full border text-xs font-medium bg-blue-600 text-white border-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-default"
          >
            –°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É
          </button>
        </div>

        <div
          id="statusText"
          class="mt-1 text-xs text-slate-500"
        ></div>
      </section>

      <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
      <section class="rounded-lg border border-slate-200 bg-slate-50 px-3 py-2.5 space-y-1.5">
        <div class="flex items-center gap-1">
          <h2 class="text-[13px] font-semibold text-slate-900">
            –°–æ–æ–±—â–µ–Ω–∏—è
          </h2>
          <span
            class="text-[11px] text-slate-400 cursor-default"
            title="–õ–æ–≥ –≤—Ö–æ–¥—è—â–∏—Ö –æ—Ç —Ö–æ—Å—Ç-–æ–∫–Ω–∞ –∏ –∏—Å—Ö–æ–¥—è—â–∏—Ö –æ—Ç –≤–∏–¥–∂–µ—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (postMessage)"
            >(?)</span
          >
        </div>

        <div
          id="messages"
          class="text-[11px] bg-slate-900 text-slate-100 rounded-md p-2 max-h-40 overflow-auto mt-1.5 space-y-0.5"
        ></div>
      </section>
    </div>

    <script>
      (function () {
        // ‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò ‚Äî –ü–û–î–°–¢–ê–í–¨ –°–í–û–ô –ë–≠–ö–ï–ù–î
        // –ë–∞–∑–æ–≤—ã–π URL —Ç–≤–æ–µ–≥–æ API (–±–µ–∑ –∑–∞–≤–µ—Ä—à–∞—é—â–µ–≥–æ —Å–ª—ç—à–∞)
        var BACKEND_BASE_URL = "https://flawiest-overjoyous-chang.ngrok-free.dev/api";

        // –≠–Ω–¥–ø–æ–∏–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏/–∏–ª–∏ —Å–æ–∑–¥–∞—ë—Ç —Å—Å—ã–ª–∫—É.
        // –ö–æ–Ω—Ç—Ä–∞–∫—Ç:
        //  POST  { contextKey, objectId }
        //    ‚Ü™ { exists: bool, link_url?: string, hide_prices?: bool, hide_total?: bool }
        //  PATCH { contextKey, objectId, hide_prices, hide_total }
        var PUBLIC_ORDER_ENDPOINT = BACKEND_BASE_URL + "/moysklad/public-order/";

        // üîß –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ DOM
        function $(id) {
          return window.document.getElementById(id);
        }

        function setText(id, text) {
          var el = $(id);
          if (el) el.textContent = text;
        }

        function setDisabled(id, disabled) {
          var el = $(id);
          if (el) el.disabled = disabled;
        }

        function setBadge(exists) {
          var el = $("linkBadge");
          if (!el) return;
          if (exists) {
            el.className =
              "inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-medium bg-emerald-100 text-emerald-700";
            el.textContent = "–°—Å—ã–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞";
          } else {
            el.className =
              "inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-medium bg-slate-200 text-slate-700";
            el.textContent = "–°—Å—ã–ª–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞";
          }
        }

        function setStatus(text, type) {
          var el = $("statusText");
          if (!el) return;
          var base = "mt-1 text-xs ";
          var color =
            type === "ok"
              ? "text-emerald-600"
              : type === "error"
              ? "text-red-600"
              : "text-slate-500";
          el.className = base + color;
          el.textContent = text || "";
        }

        function addMessage(prefix, msg) {
          var messages = $("messages");
          if (!messages) return;
          var line = document.createElement("div");
          line.className = "messages-item whitespace-pre-wrap break-words";
          var asString;
          try {
            asString = JSON.stringify(msg);
          } catch (e) {
            asString = String(msg);
          }
          line.textContent = prefix + " " + asString;
          messages.insertBefore(line, messages.firstChild);
        }

        function logReceivedMessage(msg) {
          addMessage("‚Üí Received", msg);
          console.log("‚Üí Received message:", msg);
        }

        function logSendingMessage(msg) {
          addMessage("‚Üê Sending", msg);
          console.log("‚Üê Sending message:", msg);
        }

        // üîë contextKey –∏–∑ query
        var contextKey = null;
        (function readContextKey() {
          try {
            var params = new URLSearchParams(window.location.search);
            contextKey = params.get("contextKey");
            setText(
              "contextKey",
              contextKey || "‚Äî –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ query-–ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö"
            );
          } catch (e) {
            console.error("Failed to read contextKey:", e);
          }
        })();

        // üßæ objectId –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è Open
        var objectId = null;
        var hostWindow = window.parent || window.top;

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã —Å –æ—Ç–≤–µ—Ç–æ–º –±—ç–∫–µ–Ω–¥–∞
        function syncFormFromResponse(data) {
          var exists = !!data && !!data.exists;
          setBadge(exists);

          var urlInput = $("linkUrl");
          if (!urlInput) return;

          if (exists && data.link_url) {
            urlInput.value = data.link_url;
            setDisabled("copyBtn", false);
            setDisabled("refreshBtn", false);
            setDisabled("createOrSaveBtn", false);
            $("createOrSaveBtn").textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏";
          } else {
            urlInput.value = "";
            urlInput.placeholder = "–°—Å—ã–ª–∫–∞ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω–∞";
            setDisabled("copyBtn", true);
            setDisabled("refreshBtn", false);
            setDisabled("createOrSaveBtn", false);
            $("createOrSaveBtn").textContent = "–°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É";
          }

          if (data && typeof data.hide_prices === "boolean") {
            $("hidePrices").checked = data.hide_prices;
          }
          if (data && typeof data.hide_total === "boolean") {
            $("hideTotal").checked = data.hide_total;
          }
        }

        // üöÄ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Å—ã–ª–∫–∏
        function loadPublicOrder() {
          if (!contextKey || !objectId) {
            setStatus(
              "–ù–µ—Ç contextKey –∏–ª–∏ objectId ‚Äî –∂–¥—ë–º –¥–∞–Ω–Ω—ã–µ –æ—Ç –ú–æ–π–°–∫–ª–∞–¥–∞‚Ä¶",
              "info"
            );
            return;
          }

          setStatus("–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Å—ã–ª–∫–∏‚Ä¶", "info");
          setDisabled("createOrSaveBtn", true);
          setDisabled("refreshBtn", true);

          var payload = {
            context_key: contextKey,   // –¥–ª—è Vendor API –Ω–∞ –±—ç–∫–µ–Ω–¥–µ
            ms_order_id: objectId,     // —á—Ç–æ–±—ã —Å–æ–≤–ø–∞–¥–∞–ª–æ —Å —Ç–≤–æ–µ–π –º–æ–¥–µ–ª—å—é/–ª–æ–≥–∏–∫–æ–π
          };

          fetch(PUBLIC_ORDER_ENDPOINT, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          })
            .then(function (res) {
              if (!res.ok) {
                throw new Error("HTTP " + res.status);
              }
              return res.json();
            })
            .then(function (data) {
              setStatus("–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–æ", "ok");
              syncFormFromResponse(data || {});
            })
            .catch(function (err) {
              console.error("Failed to load public order:", err);
              setStatus(
                "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Å—ã–ª–∫–∏: " + err.message,
                "error"
              );
              syncFormFromResponse({ exists: false });
            })
            .finally(function () {
              setDisabled("createOrSaveBtn", false);
              setDisabled("refreshBtn", false);
            });
        }

        // üíæ –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏
        function savePublicOrder() {
          if (!contextKey || !objectId) {
            setStatus(
              "–ù–µ—Ç contextKey –∏–ª–∏ objectId ‚Äî –ú–æ–π–°–∫–ª–∞–¥ –µ—â—ë –Ω–µ –ø–µ—Ä–µ–¥–∞–ª –∫–æ–Ω—Ç–µ–∫—Å—Ç",
              "error"
            );
            return;
          }

          var hidePrices = $("hidePrices").checked;
          var hideTotal = $("hideTotal").checked;

          setStatus("–°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É‚Ä¶", "info");
          setDisabled("createOrSaveBtn", true);

          var payload = {
            context_key: contextKey,
            ms_order_id: objectId,
            hide_prices: hidePrices,
            hide_total: hideTotal,
          };

          fetch(PUBLIC_ORDER_ENDPOINT, {
            method: "PATCH", // –∏–ª–∏ POST, –µ—Å–ª–∏ —Ç–∞–∫ –ø—Ä–æ—â–µ
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          })
            .then(function (res) {
              if (!res.ok) {
                throw new Error("HTTP " + res.status);
              }
              return res.json();
            })
            .then(function (data) {
              setStatus("–°—Å—ã–ª–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞", "ok");
              syncFormFromResponse(data || {});
            })
            .catch(function (err) {
              console.error("Failed to save public order:", err);
              setStatus(
                "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏: " + err.message,
                "error"
              );
            })
            .finally(function () {
              setDisabled("createOrSaveBtn", false);
            });
        }

        // üìã –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏
        function copyLinkToClipboard() {
          var urlInput = $("linkUrl");
          if (!urlInput || !urlInput.value) return;
          urlInput.select();
          urlInput.setSelectionRange(0, 99999);
          try {
            var ok = document.execCommand("copy");
            if (ok) {
              setStatus("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞", "ok");
            } else {
              setStatus("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É", "error");
            }
          } catch (e) {
            setStatus("–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: " + e.message, "error");
          } finally {
            window.getSelection().removeAllRanges();
          }
        }

        // üîî OpenFeedback (–ø–æ –∂–µ–ª–∞–Ω–∏—é)
        function sendOpenFeedback(receivedMessage) {
          if (!receivedMessage || typeof receivedMessage !== "object") return;
          if (!receivedMessage.messageId) return;

          var sendingMessage = {
            name: "OpenFeedback",
            correlationId: receivedMessage.messageId,
          };
          logSendingMessage(sendingMessage);
          if (hostWindow && hostWindow.postMessage) {
            hostWindow.postMessage(sendingMessage, "*");
          }
        }

        // üì® postMessage –æ—Ç –ú–æ–µ–≥–æ–°–∫–ª–∞–¥–∞
        window.addEventListener("message", function (event) {
          var receivedMessage = event.data;
          logReceivedMessage(receivedMessage);

          if (!receivedMessage || typeof receivedMessage !== "object") return;

          if (receivedMessage.name === "Open") {
            objectId = receivedMessage.objectId || null;
            setText(
              "objectId",
              objectId || "objectId = null (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞)"
            );

            // –ó–∞–≥—Ä—É–∂–∞–µ–º/–ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Å—ã–ª–∫—É
            loadPublicOrder();

            // OpenFeedback (–∫–∞–∫ –≤ –¥–µ–º–æ)
            window.setTimeout(function () {
              sendOpenFeedback(receivedMessage);
            }, 200);
          }
        });

        // üîò –ü—Ä–∏–≤—è–∑–∫–∞ –∫–Ω–æ–ø–æ–∫
        window.addEventListener("DOMContentLoaded", function () {
          var createBtn = $("createOrSaveBtn");
          var copyBtn = $("copyBtn");
          var refreshBtn = $("refreshBtn");

          if (createBtn) {
            createBtn.addEventListener("click", function () {
              savePublicOrder();
            });
          }
          if (copyBtn) {
            copyBtn.addEventListener("click", function () {
              copyLinkToClipboard();
            });
          }
          if (refreshBtn) {
            refreshBtn.addEventListener("click", function () {
              loadPublicOrder();
            });
          }

          setStatus("–ñ–¥—ë–º –¥–∞–Ω–Ω—ã–µ –æ—Ç –ú–æ–π–°–∫–ª–∞–¥–∞‚Ä¶", "info");
          setDisabled("createOrSaveBtn", false);
          setDisabled("refreshBtn", false);
        });
      })();
    </script>
  </body>
</html>
